<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | Admin User View</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f6fa;font-size:11px}
.header{padding:8px;background:#0b1a33}
.container{max-width:1200px;margin:auto;padding:8px}
.card{background:#1a2a4d;padding:8px;border-radius:6px;color:#fff}
.user-section{border-bottom:1px solid #3a4a6f;margin-bottom:6px;padding-bottom:6px}
.flex-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.deposit{color:#00ff00;font-weight:bold}
.withdraw{color:#ffeb3b;font-weight:bold}
.button{font-size:10px;padding:3px 6px;border:none;border-radius:3px;color:#fff;cursor:pointer}
.add-balance{background:#198754}
.subtract-balance{background:#ff4444}
.expand-btn{background:#ffc107;color:#000;font-weight:bold}
.table{width:100%;border-collapse:collapse;font-size:10px;margin-top:5px}
.table th,.table td{border:1px solid #3a4a6f;padding:3px}
.table th{background:#3a4a6f;color:#ffc107}
.footer{text-align:center;padding:10px}
.logout{background:#18f2c2;border:none;padding:6px 12px;border-radius:4px;font-weight:bold}
input{width:60px;font-size:10px}
</style>
</head>

<body>

<div class="header"></div>

<div class="container">
  <div class="card" id="usersList">Loading users...</div>
</div>

<div class="footer">
  <button class="logout" onclick="logout()">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,collection,getDocs,doc,
  updateDoc,increment,addDoc,serverTimestamp,
  query,where
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain:"biniyog-95d00.firebaseapp.com",
  projectId:"biniyog-95d00"
});

const auth=getAuth(app);
const db=getFirestore(app);

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="admin-login.html";
    return;
  }
  // ðŸ”¥ role à¦šà§‡à¦• à¦¬à¦¾à¦¦ â€“ à¦¯à¦¾à¦¤à§‡ à¦‡à¦‰à¦œà¦¾à¦° à¦¶à§‹ à¦¬à¦¨à§à¦§ à¦¨à¦¾ à¦¹à§Ÿ
  loadUsers();
});

async function loadUsers(){
  const box=document.getElementById("usersList");
  box.innerHTML="";
  const usersSnap=await getDocs(collection(db,"users"));
  if(usersSnap.empty){box.innerHTML="No users found";return;}

  for(const uDoc of usersSnap.docs){
    const u=uDoc.data();
    const uid=uDoc.id;

    let dep=0,wit=0;
    const tSnap=await getDocs(query(collection(db,"transactions"),where("uid","==",uid)));
    tSnap.forEach(d=>{
      const t=d.data();
      if(t.type==="credit"||t.type==="deposit") dep+=t.amount||0;
      if(t.type==="debit"||t.type==="withdraw") wit+=t.amount||0;
    });

    const div=document.createElement("div");
    div.className="user-section";
    div.innerHTML=`
      <div class="flex-row">
        <b>${u.name||"N/A"}</b>
        <span>Phone: ${u.phone||"-"}</span>
        <span>Balance: à§³<span id="bal-${uid}">${u.balance||0}</span></span>
      </div>

      <div class="flex-row">
        <span class="deposit">Deposit: à§³${dep}</span>
        <span class="withdraw">Withdraw: à§³${wit}</span>
      </div>

      <div class="flex-row">
        <input id="amt-${uid}" type="number" placeholder="Amount">
        <button class="button add-balance" onclick="changeBal('${uid}',1)">Add</button>
        <button class="button subtract-balance" onclick="changeBal('${uid}',-1)">Subtract</button>
        <button class="button expand-btn" onclick="toggle('${uid}')">Show â–¼</button>
      </div>

      <div id="hist-${uid}" style="display:none"></div>
    `;
    box.appendChild(div);
  }
}

window.changeBal=async(uid,s)=>{
  const v=parseFloat(document.getElementById("amt-"+uid).value);
  if(!v||v<=0)return alert("Invalid");
  await updateDoc(doc(db,"users",uid),{balance:increment(v*s)});
  await addDoc(collection(db,"transactions"),{
    uid,type:s>0?"credit":"debit",
    amount:v,status:"approved",createdAt:serverTimestamp()
  });
  document.getElementById("bal-"+uid).innerText=
    (+document.getElementById("bal-"+uid).innerText+v*s);
};

window.toggle=async(uid)=>{
  const d=document.getElementById("hist-"+uid);
  if(d.style.display==="block"){d.style.display="none";return;}
  d.style.display="block";
  d.innerHTML="Loading...";
  const tSnap=await getDocs(query(collection(db,"transactions"),where("uid","==",uid)));
  let h=`<table class="table"><tr><th>Type</th><th>Amount</th><th>Status</th></tr>`;
  tSnap.forEach(x=>{
    const t=x.data();
    h+=`<tr><td>${t.type}</td><td>à§³${t.amount}</td><td>${t.status}</td></tr>`;
  });
  d.innerHTML=h+"</table>";
};

window.logout=async()=>{await signOut(auth);location.href="admin-login.html"};
</script>

</body>
</html>
