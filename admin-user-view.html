<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | Admin User View</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#f4f6f9;
}
.header{
  background:#1e272e;
  color:#fff;
  padding:15px;
  text-align:center;
  font-size:18px;
}
.container{
  padding:15px;
}
.card{
  background:#fff;
  border-radius:8px;
  padding:15px;
  margin-bottom:12px;
  box-shadow:0 2px 5px rgba(0,0,0,.1);
}
.card h3{
  margin:0 0 8px;
  font-size:16px;
  color:#333;
}
.value{
  font-size:15px;
  color:#555;
}
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
.table th, .table td{
  border:1px solid #ddd;
  padding:6px;
  font-size:13px;
}
.table th{
  background:#f1f2f6;
}
.input-row{
  display:flex;
  gap:10px;
  margin-top:8px;
}
.input-row input{
  flex:1;
  padding:6px;
  font-size:14px;
  border-radius:5px;
  border:1px solid #ccc;
}
.input-row button{
  padding:6px 12px;
  background:#198754;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
.error{
  color:red;
  text-align:center;
  margin-top:30px;
}
.loading{
  text-align:center;
  margin-top:30px;
}
.back{
  display:block;
  text-align:center;
  margin-top:20px;
  text-decoration:none;
  color:#1e90ff;
}
</style>
</head>

<body>

<div class="header">ðŸ‘¤ Admin User Dashboard</div>

<div class="container" id="content">
  <div class="loading">Loading user data...</div>
</div>

<a class="back" href="admin-dashboard.html">â¬… Back to Admin Dashboard</a>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ðŸ”‘ get uid from URL */
const params = new URLSearchParams(window.location.search);
const userUid = params.get("uid");

const content = document.getElementById("content");

if(!userUid){
  content.innerHTML = "<div class='error'>User UID missing</div>";
}

/* ðŸ” Auth check */
auth.onAuthStateChanged(async(user)=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }

  const adminSnap = await db.collection("users").doc(user.uid).get();
  if(!adminSnap.exists || adminSnap.data().role !== "admin"){
    content.innerHTML = "<div class='error'>Access Denied (Admin only)</div>";
    return;
  }

  loadUser();
});

/* ðŸ“¥ Load user data */
async function loadUser(){
  try{
    const snap = await db.collection("users").doc(userUid).get();

    if(!snap.exists){
      content.innerHTML = "<div class='error'>User not found</div>";
      return;
    }

    const u = snap.data();

    content.innerHTML = `
      <div class="card">
        <h3>ðŸ‘¤ Name</h3>
        <div class="value">${u.name || "N/A"}</div>
      </div>

      <div class="card">
        <h3>ðŸ†” UID</h3>
        <div class="value">${userUid}</div>
      </div>

      <div class="card">
        <h3>ðŸ“ž Phone</h3>
        <div class="value">${u.phone || "N/A"}</div>
      </div>

      <div class="card">
        <h3>ðŸ’° Balance</h3>
        <div class="value" id="balanceDisplay">${u.balance || 0} à§³</div>

        <div class="input-row">
          <input type="number" id="balanceInput" placeholder="Add Balance">
          <button onclick="addBalance()">Add</button>
        </div>
      </div>

      <div class="card">
        <h3>ðŸ“œ Transaction History</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="txList">
            <tr><td colspan="4">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>ðŸ“¦ Plan History</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Plan Type</th>
              <th>Status</th>
              <th>Price</th>
              <th>Earned</th>
              <th>Days</th>
            </tr>
          </thead>
          <tbody id="planList">
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    `;

    loadTransactions();
    loadPlans();

  }catch(e){
    content.innerHTML = "<div class='error'>Error loading data</div>";
    console.error(e);
  }
}

/* ðŸ’¸ Add Balance */
async function addBalance(){
  const amt = parseFloat(document.getElementById("balanceInput").value);
  if(isNaN(amt) || amt <= 0) return alert("Enter valid amount");

  const userRef = db.collection("users").doc(userUid);
  await userRef.update({balance: firebase.firestore.FieldValue.increment(amt)});
  document.getElementById("balanceDisplay").innerText = 
    (parseFloat(document.getElementById("balanceDisplay").innerText) + amt) + " à§³";

  // log transaction
  await db.collection("transactions").add({
    uid: userUid,
    type:"balance_add",
    amount:amt,
    status:"approved",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("balanceInput").value = "";
  alert("Balance added successfully");
}

/* ðŸ“Š Load Transactions */
async function loadTransactions(){
  const snap = await db.collection("transactions")
    .where("uid","==",userUid)
    .orderBy("createdAt","desc")
    .get();

  const box = document.getElementById("txList");
  box.innerHTML = "";

  if(snap.empty){
    box.innerHTML = "<tr><td colspan='4'>No transactions found</td></tr>";
    return;
  }

  snap.forEach(d=>{
    const t = d.data();
    const date = t.createdAt ? t.createdAt.toDate().toLocaleString() : "-";
    box.innerHTML += `<tr>
      <td>${t.type || "-"}</td>
      <td>${t.amount || 0}</td>
      <td>${t.status || "-"}</td>
      <td>${date}</td>
    </tr>`;
  });
}

/* ðŸ“¦ Load Plans */
async function loadPlans(){
  const snap = await db.collection("user_plans")
    .where("uid","==",userUid)
    .orderBy("createdAt","desc")
    .get();

  const box = document.getElementById("planList");
  box.innerHTML = "";

  if(snap.empty){
    box.innerHTML = "<tr><td colspan='5'>No plans found</td></tr>";
    return;
  }

  snap.forEach(d=>{
    const p = d.data();
    box.innerHTML += `<tr>
      <td>${p.type || "-"}</td>
      <td>${p.status || "-"}</td>
      <td>${p.price || 0}</td>
      <td>${p.earned || 0}</td>
      <td>${p.days || "-"}</td>
    </tr>`;
  });
}
</script>

</body>
</html>
