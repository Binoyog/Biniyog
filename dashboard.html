<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biniyog | Dashboard</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f2f2f2;
}

/* Header */
.header{
  background:#d81b60;
  color:#fff;
  padding:14px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.header .left{
  display:flex;
  align-items:center;
  gap:35px;
}
.balance{
  background:#fff;
  color:#d81b60;
  padding:6px 12px;
  border-radius:20px;
  font-size:14px;
  cursor:pointer;
}
.logout, .inbox-icon{
  font-size:18px;
  cursor:pointer;
  padding:4px 8px;
  border-radius:6px;
  position:relative;
}
.inbox-badge{
  position:absolute;
  top:-6px;
  right:-6px;
  background:#22c55e;
  color:#fff;
  font-size:10px;
  font-weight:bold;
  padding:2px 5px;
  border-radius:50%;
}

/* Notice & Bonus */
.notice{
  background:#f9a825;
  margin:12px;
  padding:10px 14px;
  border-radius:6px;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:green;
}
.bonus-section{
  background:#22c55e;
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  text-align:center;
  font-size:14px;
  cursor:pointer;
}
.bonus-section:hover{
  background:#16a34a;
}

/* Menu */
.menu{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
  padding:12px;
}
.menu a{
  background:#fff;
  border-radius:50%;
  height:70px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  font-size:13px;
  color:#000;
  text-decoration:none;
}
.menu span{margin-top:6px}

/* Banner */
.banner{margin:12px}
.banner img{width:100%;border-radius:10px}

/* Inbox */
.inbox{
  background:#fff;
  margin:12px;
  padding:12px;
  border-radius:10px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.inbox h3{
  margin-top:0;
  color:#d81b60;
}
.inbox p{
  font-size:14px;
  margin:5px 0;
  color:green;
}
.scrollable{
  max-height:120px;
  overflow-y:auto;
}

/* Logout at bottom */
.fixed-logout{
  position:relative;
  bottom:0;
  display:block;
  width:auto;
  min-width:60px;
  padding:4px 10px;
  font-size:12px;
  text-align:center;
  background:#d81b60;
  color:#fff;
  cursor:pointer;
  border-radius:8px;
  margin:12px auto;
}
</style>
</head>

<body>

<div class="header">
  <div class="left">
    <strong id="luckyBtn">üéØ Lucky Bet</strong>
    <div class="balance" id="balanceBtn">Tap To Balance</div>
  </div>
  <div class="icons">
    <div class="inbox-icon" id="inboxIcon">üì®
      <span class="inbox-badge" id="inboxBadge" style="display:none;">0</span>
    </div>
  </div>
</div>

<div class="notice">
  <span>‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ</span>
  <div class="bonus-section" id="claimBonusBtn">Claim Today's Bonus</div>
</div>

<div class="menu">
  <a href="task.html">üìã<span>Task</span></a>
  <a href="deposit.html">üí∞<span>Deposit</span></a>
  <a href="withdraw.html">üèß<span>Withdraw</span></a>
  <a href="plan.html">üì¶<span>Plan</span></a>
  <a href="profile.html">üë§<span>Profile</span></a>
  <a href="refer.html">üë•<span>Refer</span></a>
  <a href="transaction.html">üîÑ<span>Transaction</span></a>
  <a href="about.html">‚ÑπÔ∏è<span>About</span></a>
</div>

<!-- Banner: GitHub Image -->
<div class="banner">
  <img id="bannerImg" src="" alt="Banner Image">
</div>

<!-- Inbox Section -->
<div class="inbox" id="inboxSection" style="display:none;">
  <h3>Inbox</h3>
  <div class="scrollable" id="inboxList">
    <p>No messages yet.</p>
  </div>
</div>

<div class="fixed-logout" id="logoutBtn">‚éã Logout</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  collection,
  onSnapshot,
  getDoc,
  setDoc,
  updateDoc,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const balanceBtn = document.getElementById("balanceBtn");
const luckyBtn = document.getElementById("luckyBtn");
const claimBonusBtn = document.getElementById("claimBonusBtn");
const inboxList = document.getElementById("inboxList");
const inboxSection = document.getElementById("inboxSection");
const inboxIcon = document.getElementById("inboxIcon");
const inboxBadge = document.getElementById("inboxBadge");
const logoutBtn = document.getElementById("logoutBtn");
const bannerImg = document.getElementById("bannerImg");

let showBalance = false;
let liveBalance = 0;
let currentUser = null;

/* ===============================
   GitHub Banner Image Setup
   =============================== */
const githubUser = "YOUR_GITHUB_USERNAME";
const githubRepo = "YOUR_REPO_NAME";
const githubBranch = "main";  // ‡¶Ø‡¶¶‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ branch main ‡¶®‡¶æ ‡¶π‡ßü ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¨‡¶¶‡¶≤‡ßá ‡¶¶‡¶ø‡¶¨‡ßá

bannerImg.src = `https://raw.githubusercontent.com/${githubUser}/${githubRepo}/${githubBranch}/assets/Big-offer.png`;

/* ===============================
   AUTH + LOAD BALANCE
=================================*/
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.replace("index.html");
    return;
  }
  currentUser = user;

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  const today = new Date().toISOString().split("T")[0];

  const baseData = {
    uid: user.uid,
    name: snap.exists() ? snap.data().name || "" : "",
    phone: snap.exists() ? snap.data().phone || "" : "",
    role: snap.exists() ? snap.data().role || "user" : "user",
    balance: snap.exists() ? snap.data().balance || 0 : 0,
    loginStreak: snap.exists() ? snap.data().loginStreak || 0 : 0,
    lastLoginDate: snap.exists() ? snap.data().lastLoginDate || "" : today,
    createdAt: snap.exists() ? snap.data().createdAt || serverTimestamp() : serverTimestamp(),
  };

  if(!snap.exists()){
    await setDoc(userRef, baseData);
  } else {
    await updateDoc(userRef, baseData);
  }

  onSnapshot(userRef,(docSnap)=>{
    if(docSnap.exists()){
      liveBalance = docSnap.data().balance || 0;
      if(showBalance){
        balanceBtn.innerText = "¬© " + liveBalance;
      }
    }
  });

  const inboxRef = collection(db,"inbox");
  const inboxQuery = query(inboxRef, orderBy("createdAt","desc"));
  onSnapshot(inboxQuery,(snapshot)=>{
    let unreadCount = 0;
    inboxList.innerHTML = "";
    if(snapshot.empty){
      inboxList.innerHTML = "<p>No messages yet.</p>";
    }
    snapshot.forEach(doc=>{
      const data = doc.data();
      if(data.uid === user.uid){
        const p = document.createElement("p");
        p.innerText = data.message || "";
        inboxList.appendChild(p);
        if(!data.read){
          unreadCount++;
        }
      }
    });
    if(unreadCount>0){
      inboxBadge.style.display = "inline";
      inboxBadge.innerText = unreadCount;
    } else {
      inboxBadge.style.display = "none";
    }
  });
});

/* Balance toggle */
balanceBtn.addEventListener("click",()=>{
  showBalance = !showBalance;
  balanceBtn.innerText = showBalance ? "‚Üí " + liveBalance : "Tap To Balance";
});

/* Lucky Bet */
luckyBtn.addEventListener("click",()=>{ window.location.href = "lucky-bet.html"; });

/* Inbox redirect */
inboxIcon.addEventListener("click",()=>{ window.location.href = "inbox.html"; });

/* Logout */
logoutBtn.addEventListener("click", async ()=>{
  await signOut(auth);
  window.location.replace("index.html");
});

/* Daily Login Bonus Claim */
claimBonusBtn.addEventListener("click", async ()=>{
  if(!currentUser) return;

  const userRef = doc(db,"users",currentUser.uid);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.exists() ? userSnap.data() : {};

  const today = new Date().toISOString().split("T")[0];
  const yesterday = new Date(Date.now() - 86400000).toISOString().split("T")[0];

  if(userData.lastLoginDate === today){
    claimBonusBtn.innerText = "Already Claimed ‚úîÔ∏è";
    return;
  }

  let streak = (userData.lastLoginDate === yesterday) ? (userData.loginStreak || 0) + 1 : 1;
  if(streak > 7) streak = 1;

  const bonus = (streak === 7) ? 40 : 20;
  const newBalance = (userData.balance || 0) + bonus;

  await updateDoc(userRef,{
    balance: newBalance,
    loginStreak: streak,
    lastLoginDate: today
  });

  claimBonusBtn.innerText = `‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∞‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡ß≥${bonus} ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úîÔ∏è`;
  showBalance = true;
  balanceBtn.innerText = "‡ß≥ " + newBalance;
});
</script>

</body>
</html>
