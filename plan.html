<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Biniyog | My Plans</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f4f4f4;
}
.header{
  padding:16px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
  background:#b23a1e;
  color:#fff;
}
.plan{
  background:#fff;
  margin:15px;
  border-radius:15px;
  padding:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
.plan h3{margin:0 0 6px 0}
.time{
  font-size:16px;
  font-weight:bold;
  color:#b23a1e;
  margin-top:8px;
}
.status{
  margin-top:6px;
  font-size:14px;
}
.completed{
  color:green;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="header">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶≤‡¶æ‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</div>
<div id="plans"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,collection,query,where,getDocs,
  doc,updateDoc,increment
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain:"biniyog-95d00.firebaseapp.com",
  projectId:"biniyog-95d00"
});

const auth = getAuth(app);
const db = getFirestore(app);

const plansDiv = document.getElementById("plans");

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  const q = query(
    collection(db,"user_plans"),
    where("uid","==",user.uid)
  );

  const snap = await getDocs(q);
  snap.forEach(docSnap=>{
    renderPlan(docSnap.id, docSnap.data(), user.uid);
  });
});

function renderPlan(id, plan, uid){
  const box = document.createElement("div");
  box.className = "plan";

  box.innerHTML = `
    <h3>${plan.planName}</h3>
    <div class="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ${plan.status}</div>
    <div class="time" id="time-${id}"></div>
  `;

  plansDiv.appendChild(box);

  if(plan.type === "flash"){
    startFlashCountdown(id, plan, uid);
  }else{
    showDailyTime(id, plan);
  }
}

/* üî• FLASH PLAN (SECOND COUNTDOWN + SAFE PROFIT) */
function startFlashCountdown(planId, plan, uid){
  const el = document.getElementById("time-"+planId);
  const planRef = doc(db,"user_plans",planId);
  const userRef = doc(db,"users",uid);

  const timer = setInterval(async()=>{
    const now = Date.now();
    let diff = plan.endTime - now;

    if(diff <= 0){
      clearInterval(timer);
      el.innerHTML = "‚è∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑";

      if(!plan.profitAdded){
        await updateDoc(userRef,{
          balance: increment(plan.totalEarn)
        });
        await updateDoc(planRef,{
          profitAdded:true,
          status:"completed"
        });
        el.innerHTML = `<span class="completed">‚úÖ ‡¶Ü‡ßü ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá</span>`;
      }
      return;
    }

    const min = Math.floor(diff / 60000);
    const sec = Math.floor((diff % 60000) / 1000);
    el.innerText = `‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßü: ${min} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ${sec} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°`;
  },1000);
}

/* üìÖ DAILY PLAN */
function showDailyTime(id, plan){
  const el = document.getElementById("time-"+id);
  const diff = plan.endTime - Date.now();
  const days = Math.max(0, Math.ceil(diff / 86400000));
  el.innerText = `üìÖ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶¶‡¶ø‡¶®: ${days}`;
}
</script>

</body>
</html>
