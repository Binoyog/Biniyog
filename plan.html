<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Biniyog | My Plans</title>
<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#fdecec;
}
.header{
  padding:16px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}
.plan{
  background:#b23a1e;
  color:#fff;
  margin:15px;
  border-radius:18px;
  padding:20px;
}
.plan h3{margin:5px 0}
.plan p{margin:6px 0;font-size:15px}
.time{
  margin-top:8px;
  font-weight:bold;
  font-size:16px;
}
.done{
  color:#facc15;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="header">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶≤‡¶æ‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</div>
<div id="plans"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { 
  getFirestore,collection,query,where,getDocs,
  doc,updateDoc,increment 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain:"biniyog-95d00.firebaseapp.com",
  projectId:"biniyog-95d00"
});

const auth = getAuth(app);
const db = getFirestore(app);

const plansDiv = document.getElementById("plans");

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    location.href="index.html";
    return;
  }

  const q = query(collection(db,"user_plans"), where("uid","==",user.uid));
  const snap = await getDocs(q);

  snap.forEach(docSnap => {
    const data = docSnap.data();
    renderPlan(docSnap.id, data, user.uid);
  });
});

function renderPlan(id, plan, uid){
  const div = document.createElement("div");
  div.className = "plan";
  div.innerHTML = `
    <h3>${plan.planName}</h3>
    <p>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ${plan.status}</p>
    <div class="time" id="time-${id}"></div>
  `;
  plansDiv.appendChild(div);

  if(plan.type === "flash"){
    flashTimer(id, plan, uid);
  }else{
    dailyTimer(id, plan, uid);
  }
}

/* üî• FLASH PLAN REAL-TIME SECOND COUNTDOWN */
function flashTimer(pid, plan, uid){
  const el = document.getElementById("time-"+pid);
  const planRef = doc(db,"user_plans",pid);
  const userRef = doc(db,"users",uid);

  const timer = setInterval(async()=>{
    const now = Date.now();
    let diff = plan.endAt - now;

    if(diff <= 0){
      clearInterval(timer);
      el.innerHTML = "‚è∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑";

      if(!plan.profitAdded){
        await updateDoc(userRef, { balance: increment(plan.totalEarn) });
        await updateDoc(planRef, { profitAdded:true, status:"completed" });
        el.innerHTML = `<span class="done">‚úÖ ‡¶Ü‡ßü ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá</span>`;
      }
      return;
    }

    const min = Math.floor(diff / 60000);
    const sec = Math.floor((diff % 60000) / 1000);
    el.innerText = `‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßü: ${min} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ${sec} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°`;
  },1000);
}

/* üìÖ DAILY PLAN - Countdown in days (optional seconds can be added similarly) */
function dailyTimer(pid, plan, uid){
  const el = document.getElementById("time-"+pid);
  const planRef = doc(db,"user_plans",pid);
  const userRef = doc(db,"users",uid);

  const timer = setInterval(async()=>{
    const now = Date.now();
    let diff = plan.endAt - now;

    if(diff <= 0){
      clearInterval(timer);
      el.innerHTML = "‚è∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑";

      if(!plan.profitAdded){
        await updateDoc(userRef, { balance: increment(plan.totalEarn) });
        await updateDoc(planRef, { profitAdded:true, status:"completed" });
        el.innerHTML = `<span class="done">‚úÖ ‡¶Ü‡ßü ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá</span>`;
      }
      return;
    }

    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    el.innerText = `‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßü: ${days} ‡¶¶‡¶ø‡¶® ${hours} ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ${minutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ${seconds} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°`;
  },1000);
}
</script>

</body>
</html>
