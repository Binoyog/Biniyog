<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Admin | Deposit Approval</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:sans-serif;
  background:#f5f6fa;
  padding:15px;
}
.card{
  background:#fff;
  padding:15px;
  margin-bottom:12px;
  border-radius:8px;
}
button{
  padding:8px 12px;
  margin-right:5px;
  border:none;
  cursor:pointer;
}
.approve{background:green;color:#fff}
.reject{background:red;color:#fff}
</style>
</head>

<body>
<h2>Pending Deposits</h2>
<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, doc, getDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const list = document.getElementById("list");

const q = query(
  collection(db,"transactions"),
  where("status","==","pending"),
  where("type","==","deposit")
);

const snap = await getDocs(q);

snap.forEach(docSnap=>{
  const d = docSnap.data();
  const div = document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <p><b>User:</b> ${d.uid}</p>
    <p><b>Amount:</b> à§³${d.amount}</p>
    <p><b>Method:</b> ${d.method}</p>
    <p><b>TRX:</b> ${d.trxId}</p>
    <button class="approve">Approve</button>
    <button class="reject">Reject</button>
  `;

  div.querySelector(".approve").onclick = async ()=>{
    // update transaction
    await updateDoc(doc(db,"transactions",docSnap.id),{
      status:"approved"
    });

    // add balance
    const userRef = doc(db,"users",d.uid);
    const userSnap = await getDoc(userRef);

    if(userSnap.exists()){
      await updateDoc(userRef,{
        balance: increment(d.amount)
      });
    }

    alert("Approved & balance added");
    location.reload();
  };

  div.querySelector(".reject").onclick = async ()=>{
    await updateDoc(doc(db,"transactions",docSnap.id),{
      status:"rejected"
    });
    alert("Rejected");
    location.reload();
  };

  list.appendChild(div);
});
</script>
</body>
</html>
