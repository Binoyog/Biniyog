<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Tasks</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f2f2f2;
}
.header{
  background:#0b0f0e;
  color:#1abc9c;
  padding:14px;
  font-size:20px;
  text-align:center;
}
.card{
  background:#fff;
  margin:12px;
  padding:15px;
  border-radius:10px;
}
.card h3{ margin:4px 0; color:#d81b60 }
.card p{ margin:3px 0; font-size:14px }
.status{
  margin-top:8px;
  font-weight:bold;
}
.running{ color:#1abc9c }
.completed{ color:green }
</style>
</head>

<body>

<div class="header">üìã ‡¶Ü‡¶Æ‡¶æ‡¶∞ Task</div>
<div id="taskList">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { 
  getFirestore,collection,getDocs,doc,updateDoc,getDoc 
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
 apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
 projectId:"biniyog-95d00"
});

const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async(user)=>{
 if(!user){
   location.href="index.html";
   return;
 }

 const list = document.getElementById("taskList");
 list.innerHTML = "";

 const snap = await getDocs(collection(db,"users",user.uid,"plans"));

 if(snap.empty){
   list.innerHTML = "‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶®‡ßá‡¶á";
   return;
 }

 for(const d of snap.docs){
   const p = d.data();
   const now = Date.now();
   const passedDays = Math.floor((now - p.start) / 86400000);
   const earned = Math.min(passedDays, p.days) * p.daily;
   const remaining = Math.max(p.days - passedDays, 0);

   /* üî• Plan complete ‡¶π‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó */
   if(passedDays >= p.days && p.status === "running"){
     const userRef = doc(db,"users",user.uid);
     const usnap = await getDoc(userRef);

     await updateDoc(userRef,{
       balance: usnap.data().balance + (p.daily * p.days)
     });

     await updateDoc(doc(db,"users",user.uid,"plans",d.id),{
       status:"completed"
     });
   }

   const div = document.createElement("div");
   div.className = "card";
   div.innerHTML = `
     <h3>${p.name}</h3>
     <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶Ü‡ßü: ‡ß≥${p.daily}</p>
     <p>‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶: ${p.days} ‡¶¶‡¶ø‡¶®</p>
     <p>‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá: ${remaining} ‡¶¶‡¶ø‡¶®</p>
     <p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü: ‡ß≥${earned}</p>
     <div class="status ${p.status}">
       ${p.status === "completed" ? "‚úÖ Completed" : "‚è≥ Running"}
     </div>
   `;
   list.appendChild(div);
 }
});
</script>

</body>
</html>
