<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Biniyog | My Tasks</title>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.header{background:#d81b60;color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:bold}
.card{background:#fff;margin:12px;padding:15px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.card h3{margin:0 0 8px;color:#d81b60}
.row{font-size:14px;margin:4px 0}
.badge{display:inline-block;padding:5px 14px;border-radius:20px;font-size:12px;margin-top:8px}
.running{background:#e3f2fd;color:#1565c0}
.completed{background:#e8f5e9;color:#2e7d32}
.timer{font-weight:bold;color:#d81b60}
.empty{text-align:center;margin-top:40px;color:#777}
</style>
</head>

<body>

<div class="header">üìã My Task / Plans</div>
<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,collection,query,where,getDocs,
  doc,updateDoc,getDoc,increment
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  projectId:"biniyog-95d00"
});

const auth=getAuth(app);
const db=getFirestore(app);
const list=document.getElementById("list");

onAuthStateChanged(auth,user=>{
  if(!user){ location.href="index.html"; return; }
  loadPlans(user.uid);
});

async function loadPlans(uid){
  list.innerHTML="";
  const q=query(collection(db,"user_plans"),where("uid","==",uid));
  const snap=await getDocs(q);

  if(snap.empty){
    list.innerHTML="<div class='empty'>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶® ‡¶®‡ßá‡¶á</div>";
    return;
  }

  snap.forEach(d=>handlePlan(d.id,d.data(),uid));
}

async function handlePlan(id,d,uid){
  const div=document.createElement("div");
  div.className="card";
  list.appendChild(div);

  const now=Date.now();
  const ended = now >= d.endAt;

  // üî• AUTO CREDIT (even if user was offline)
  if(ended && d.status==="running"){
    const planRef=doc(db,"user_plans",id);
    const fresh=await getDoc(planRef);
    if(fresh.data().status==="running"){
      await updateDoc(doc(db,"users",uid),{
        balance: increment(d.totalEarn)
      });
      await updateDoc(planRef,{
        earned:d.totalEarn,
        status:"completed",
        credited:true
      });
      d.status="completed";
    }
  }

  if(d.status==="completed"){
    div.innerHTML=`
      <h3>${d.planName}</h3>
      <div class="row">üí∞ ‡¶¨‡¶ø‡¶®‡¶ø‡ßü‡ßã‡¶ó: ‡ß≥ ${d.price}</div>
      <div class="row">‚úÖ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®: ‡ß≥ ${d.totalEarn}</div>
      <div class="badge completed">plan complete</div>
    `;
    return;
  }

  div.innerHTML=`
    <h3>${d.planName}</h3>
    <div class="row">üí∞ ‡¶¨‡¶ø‡¶®‡¶ø‡ßü‡ßã‡¶ó: ‡ß≥ ${d.price}</div>
    <div class="row">‚úÖ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®: ‡ß≥ ${d.earned||0}</div>
    <div class="row timer" id="t-${id}"></div>
    <div class="badge running">‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</div>
  `;

  const timer=document.getElementById(`t-${id}`);

  const loop=setInterval(()=>{
    const r=d.endAt-Date.now();
    if(r<=0){
      timer.innerText="‚è∞ ‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑";
      clearInterval(loop);
      return;
    }
    const m=Math.floor(r/60000);
    const s=Math.floor((r%60000)/1000);
    timer.innerText=`‚è≥ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßü: ${m}m ${s}s`;
  },1000);
}
</script>

</body>
</html>
