<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Bet | Coin Flip</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background:#0f0f17;
    color: #fff;
    display:flex;
    justify-content:center;
    padding-top:30px;
}
.container {
    width: 100%;
    max-width: 420px;
    padding:20px;
}
.header{
    text-align:center;
    font-size:24px;
    font-weight:bold;
    margin-bottom:14px;
    color:#e91e63;
}
.balance{
    text-align:center;
    font-size:20px;
    margin-bottom:20px;
    color:#4caf50;
}
.bet-area{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:20px;
}
.bet-area input{
    width:90px;
    padding:8px;
    font-size:16px;
    border-radius:8px;
    border:none;
    text-align:center;
}
.coin{
    width:150px;
    height:150px;
    margin:0 auto 20px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:30px;
    color:#000;
    perspective:1000px;
}
.coin-inner{
    width:100%;
    height:100%;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:32px;
    font-weight:bold;
    backface-visibility:hidden;
    transition:transform 1s ease;
}
.buttons{
    display:flex;
    justify-content:center;
    gap:15px;
}
.buttons button{
    padding:10px 20px;
    font-size:16px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
    background:#e91e63;
    color:#fff;
    transition:0.2s;
}
.buttons button:hover{
    background:#ff4081;
}
.result{
    text-align:center;
    font-size:18px;
    margin-top:18px;
    min-height:24px;
}
.history{
    margin-top:24px;
    font-size:18px;
}
.history ul{
    list-style:none;
    padding-left:0;
}
.history li{
    margin-bottom:6px;
    padding:6px 8px;
    background:#1f1f2f;
    border-radius:6px;
}
</style>
</head>
<body>

<div class="container">
    <div class="header">ðŸª™ Coin Flip</div>
    <div class="balance" id="balanceBtn">Balance: à§³0</div>

    <div class="bet-area">
        <label>Bet à§³</label>
        <input type="number" id="betAmount" value="50" min="10">
    </div>

    <div class="coin">
        <div class="coin-inner" id="coinInner">?</div>
    </div>

    <div class="buttons">
        <button onclick="flipCoin('Heads')">Heads</button>
        <button onclick="flipCoin('Tails')">Tails</button>
    </div>

    <div class="result" id="result"></div>

    <div class="history">
        <strong>Recent Flips:</strong>
        <ul id="historyList"></ul>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, serverTimestamp, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let liveBalance = 0;
let userRef;

const balanceBtn = document.getElementById('balanceBtn');
const coinInner = document.getElementById('coinInner');
const resultDiv = document.getElementById('result');
const historyList = document.getElementById('historyList');
const betInput = document.getElementById('betAmount');

onAuthStateChanged(auth, async user => {
    if(!user){
        location.href="index.html";
        return;
    }
    userRef = doc(db,"users",user.uid);

    onSnapshot(userRef, docSnap => {
        if(docSnap.exists()){
            liveBalance = docSnap.data().balance || 0;
            balanceBtn.innerText = "Balance: à§³"+liveBalance;
        }
    });
});

/* Maintain history in Firestore */
async function addHistory(outcome, bet, resultText){
    const historyRef = collection(db,"coinFlipHistory");
    await addDoc(historyRef, {
        uid: auth.currentUser.uid,
        outcome,
        bet,
        resultText,
        timestamp: serverTimestamp()
    });
}

/* show recent flips */
const histQuery = query(collection(db,"coinFlipHistory"), orderBy("timestamp","desc"), limit(8));
onSnapshot(histQuery, snapshot => {
    historyList.innerHTML = "";
    snapshot.forEach(doc => {
        const d = doc.data();
        const li = document.createElement("li");
        li.innerText = `${d.outcome} | Bet: à§³${d.bet} | ${d.resultText}`;
        historyList.appendChild(li);
    });
});

async function flipCoin(userChoice){
    const bet = parseInt(betInput.value);
    if(isNaN(bet) || bet <=0 || bet > liveBalance){
        alert("Invalid bet amount!");
        return;
    }

    // Animate coin
    coinInner.style.transform = "rotateY(720deg)";
    coinInner.innerText="?";
    resultDiv.innerText="";
  
    setTimeout( async ()=>{
        const outcome = Math.random() < 0.5 ? "Heads" : "Tails";
        coinInner.innerText = outcome;

        let resText="";
        let newBalance = liveBalance;

        if(userChoice === outcome){
            newBalance += bet;
            resText = `ðŸŽ‰ WON +à§³${bet}`;
        } else {
            newBalance -= bet;
            resText = `ðŸ˜ž LOST -à§³${bet}`;
        }
        resultDiv.innerText = resText;

        await updateDoc(userRef,{
            balance: newBalance,
            lastFlipTime: serverTimestamp()
        });

        await addHistory(outcome, bet, resText);
    }, 900);
}

</script>

</body>
</html>
