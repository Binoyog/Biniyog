<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Inbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial}
.container{display:flex;height:100vh}
.users{width:30%;border-right:1px solid #ddd;overflow-y:auto}
.user{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user:hover{background:#f5f5f5}
.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;overflow-y:auto;padding:10px}
.msg{margin:6px 0;padding:8px;border-radius:6px;max-width:70%}
.admin{background:#d81b60;color:#fff;margin-left:auto}
.userMsg{background:#eee}
.footer{display:flex;padding:10px;gap:6px}
</style>
</head>
<body>

<div class="container">
  <div class="users" id="users"></div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="footer">
      <input type="text" id="msg" placeholder="Reply">
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getFirestore,collection,query,orderBy,onSnapshot,addDoc,doc,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  projectId:"YOUR_PROJECT_ID"
});
const db = getFirestore(app);

let currentUID=null;

const q = query(collection(db,"chats"),orderBy("updatedAt","desc"));
onSnapshot(q,snap=>{
  users.innerHTML="";
  snap.forEach(d=>{
    const div=document.createElement("div");
    div.className="user";
    div.innerText=d.id+" : "+(d.data().lastMessage||"");
    div.onclick=()=>openChat(d.id);
    users.appendChild(div);
  });
});

function openChat(uid){
  currentUID=uid;
  const q2=query(collection(db,"chats",uid,"messages"),orderBy("createdAt"));
  onSnapshot(q2,snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.from==="admin"?"admin":"userMsg");
      div.innerText=m.text||"ðŸ“Ž File";
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

send.onclick=async()=>{
  if(!msg.value||!currentUID) return;

  await addDoc(collection(db,"chats",currentUID,"messages"),{
    text:msg.value,
    from:"admin",
    createdAt:serverTimestamp()
  });

  await doc(db,"chats",currentUID).set({
    lastMessage:msg.value,
    updatedAt:serverTimestamp()
  },{merge:true});

  msg.value="";
};
</script>

</body>
</html>
