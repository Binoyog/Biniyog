<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Inbox</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; }
  .container { padding: 12px; }
  .user-list { display: flex; flex-direction: column; gap: 10px; }
  .user-card { background: #fff; padding: 10px; border-radius: 8px; cursor: pointer; }
  .chat-box { margin-top: 12px; background: #fff; padding: 10px; border-radius: 8px; }
  .msg { margin: 6px 0; padding: 8px; border-radius: 8px; }
  .from-user { background: #d1e7dd; }
  .from-admin { background: #f8d7da; }
</style>
</head>
<body>

<div class="container">
  <h2>Admin Inbox</h2>
  <div id="users" class="user-list"></div>

  <div id="chatBox" class="chat-box" style="display:none;">
    <h3 id="chatUser"></h3>
    <div id="messages"></div>

    <textarea id="adminMsg" placeholder="Type your message..." style="width:100%; height:80px;"></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  doc,
  setDoc,
  addDoc,
  serverTimestamp,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let selectedUid = null;
let selectedName = "";

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  // Only admin can access
  // You must check role in users collection
  // For simplicity, we assume this is admin
  loadUsers();
});

function loadUsers() {
  const q = query(collection(db, "chats"), orderBy("updatedAt", "desc"));
  onSnapshot(q, (snap) => {
    const users = document.getElementById("users");
    users.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "user-card";
      div.innerText = data.name + " - " + data.lastMessage;
      div.onclick = () => openChat(data.uid, data.name);
      users.appendChild(div);
    });
  });
}

async function openChat(uid, name) {
  selectedUid = uid;
  selectedName = name;
  document.getElementById("chatBox").style.display = "block";
  document.getElementById("chatUser").innerText = name;

  // mark unreadByAdmin false
  await updateDoc(doc(db, "chats", uid), { unreadByAdmin: false });

  // load messages
  const q = query(collection(db, "messages"), where("uid", "==", uid), orderBy("createdAt", "asc"));
  onSnapshot(q, (snap) => {
    const msgDiv = document.getElementById("messages");
    msgDiv.innerHTML = "";
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const p = document.createElement("div");
      p.className = "msg " + (m.from === "admin" ? "from-admin" : "from-user");
      p.innerText = m.text;
      msgDiv.appendChild(p);
    });
  });
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const text = document.getElementById("adminMsg").value;
  if (!text || !selectedUid) return;

  await addDoc(collection(db, "messages"), {
    uid: selectedUid,
    from: "admin",
    text: text,
    seen: false,
    createdAt: serverTimestamp(),
    fileUrl: "",
    fileType: ""
  });

  await setDoc(doc(db, "chats", selectedUid), {
    uid: selectedUid,
    name: selectedName,
    lastFrom: "admin",
    lastMessage: text,
    unreadByUser: true,
    unreadByAdmin: false,
    updatedAt: serverTimestamp()
  }, { merge: true });

  document.getElementById("adminMsg").value = "";
});
</script>
</body>
</html>
