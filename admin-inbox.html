<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Admin Inbox | Biniyog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#e5ddd5;
  }
  .app{
    display:flex;
    height:100vh;
  }

  /* Left Sidebar */
  .sidebar{
    width:30%;
    max-width:380px;
    background:#f0f0f0;
    border-right:1px solid #ccc;
    display:flex;
    flex-direction:column;
  }
  .sidebar-header{
    background:#075e54;
    color:#fff;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .sidebar-header h2{
    margin:0;
    font-size:16px;
  }
  .search{
    padding:10px;
    background:#f6f6f6;
  }
  .search input{
    width:100%;
    padding:8px;
    border-radius:20px;
    border:1px solid #ddd;
    font-size:14px;
  }
  .user-list{
    flex:1;
    overflow-y:auto;
  }
  .user-item{
    padding:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #ddd;
    cursor:pointer;
    background:#fff;
  }
  .user-item:hover{ background:#f7f7f7; }
  .user-info{
    display:flex;
    flex-direction:column;
  }
  .user-info b{ font-size:14px; }
  .user-info span{ font-size:12px; color:#555; }
  .badge{
    background:#25d366;
    color:#fff;
    padding:3px 8px;
    border-radius:12px;
    font-size:12px;
  }

  /* Chat Area */
  .chat-area{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#e5ddd5;
  }
  .chat-header{
    background:#075e54;
    color:#fff;
    padding:15px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .chat-header img{
    width:40px;
    height:40px;
    border-radius:50%;
    background:#fff;
  }
  .chat-header b{
    font-size:16px;
  }
  .messages{
    flex:1;
    padding:15px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .message{
    max-width:60%;
    padding:10px 12px;
    border-radius:10px;
    font-size:14px;
    line-height:1.3;
  }
  .msg-user{
    background:#dcf8c6;
    align-self:flex-end;
  }
  .msg-admin{
    background:#fff;
    align-self:flex-start;
  }
  .msg-time{
    font-size:11px;
    color:#666;
    margin-top:4px;
    text-align:right;
  }

  .chat-footer{
    padding:10px;
    background:#f0f0f0;
    display:flex;
    gap:8px;
  }
  .chat-footer input{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:1px solid #ddd;
    font-size:14px;
  }
  .chat-footer button{
    background:#25d366;
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:20px;
    cursor:pointer;
    font-size:14px;
  }

  @media(max-width:768px){
    .sidebar{ width:100%; max-width:none; }
    .chat-area{ display:none; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- LEFT -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Inbox</h2>
      <span id="logoutBtn" style="cursor:pointer;">Logout</span>
    </div>

    <div class="search">
      <input type="text" id="search" placeholder="Search phone...">
    </div>

    <div class="user-list" id="userList">
      Loading...
    </div>
  </div>

  <!-- RIGHT -->
  <div class="chat-area" id="chatArea">
    <div class="chat-header" id="chatHeader">
      <img src="https://i.imgur.com/0y0y0y0.png" alt="user">
      <b>Select a user to chat</b>
    </div>

    <div class="messages" id="messages">
      <div style="text-align:center;color:#666;">No conversation selected</div>
    </div>

    <div class="chat-footer">
      <input type="text" id="msgInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let selectedUser = null;
let chatId = null;

// AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if(!user) return location.href="admin-login.html";
  const uSnap = await getDoc(doc(db,"users",user.uid));
  if(!uSnap.exists() || uSnap.data().role !== "admin"){
    alert("Access denied");
    await signOut(auth);
    location.href="admin-login.html";
    return;
  }

  loadUsers();
});

// LOGOUT
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href="admin-login.html";
}

// LOAD USERS LIST
async function loadUsers(){
  const list = document.getElementById("userList");
  list.innerHTML = "";

  // get chats order by updatedAt desc
  const q = query(collection(db,"chats"), orderBy("updatedAt","desc"));
  onSnapshot(q, (snap)=>{
    list.innerHTML = "";
    snap.docs.forEach(docSnap=>{
      const data = docSnap.data();
      const phone = data.name; // name field holds phone (as you asked)
      const lastMsg = data.lastMessage;
      const unread = data.unreadByAdmin ? "new" : "";

      list.innerHTML += `
        <div class="user-item" onclick="openChat('${docSnap.id}')">
          <div class="user-info">
            <b>${phone}</b>
            <span>${lastMsg}</span>
          </div>
          ${unread ? `<span class="badge">New</span>` : ""}
        </div>
      `;
    });
  });
}

// OPEN CHAT
window.openChat = async (id) => {
  chatId = id;
  const cSnap = await getDoc(doc(db,"chats",id));
  if(!cSnap.exists()) return;

  const cData = cSnap.data();
  selectedUser = cData.uid;

  document.getElementById("chatHeader").innerHTML = `
    <img src="https://i.imgur.com/0y0y0y0.png" alt="user">
    <b>${cData.name}</b>
  `;

  loadMessages();
}

// LOAD MESSAGES
function loadMessages(){
  const msgBox = document.getElementById("messages");
  msgBox.innerHTML = "";

  const q = query(collection(db,"messages"), where("uid","==",selectedUser), orderBy("createdAt","asc"));

  onSnapshot(q, (snap)=>{
    msgBox.innerHTML = "";
    snap.docs.forEach(docSnap=>{
      const m = docSnap.data();
      const cls = m.from === "admin" ? "msg-user" : "msg-admin";
      const time = new Date(m.createdAt.toDate()).toLocaleTimeString();

      msgBox.innerHTML += `
        <div class="message ${cls}">
          ${m.text}
          <div class="msg-time">${time}</div>
        </div>
      `;
    });

    msgBox.scrollTop = msgBox.scrollHeight;
  });
}

// SEND MESSAGE
document.getElementById("sendBtn").onclick = async () => {
  const text = document.getElementById("msgInput").value.trim();
  if(!text) return alert("Type a message");

  if(!chatId || !selectedUser) return alert("Select a user first");

  const now = serverTimestamp();

  // create message
  await addDoc(collection(db,"messages"),{
    uid: selectedUser,
    from: "admin",
    text: text,
    fileUrl: "",
    fileType: "",
    seen: false,
    createdAt: now,
    updatedAt: now
  });

  // update chat last message
  await updateDoc(doc(db,"chats",chatId),{
    lastFrom: "admin",
    lastMessage: text,
    unreadByUser: true,
    unreadByAdmin: false,
    updatedAt: now
  });

  document.getElementById("msgInput").value = "";
};
</script>
</body>
</html>
