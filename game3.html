<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Bet | Slot Game</title>
<style>
body{
  margin:0; font-family:Arial, Helvetica, sans-serif; background:#f2f2f2;
}
.header{
  background:#d81b60; color:#fff; padding:14px; display:flex; justify-content:space-between; align-items:center;
}
.header .left{ cursor:pointer; font-weight:bold; }
.header .balance{ background:#fff; color:#d81b60; padding:6px 14px; border-radius:20px; cursor:pointer; }
.logout{ cursor:pointer; font-size:20px; }
.notice{ background:#f9a825; margin:12px; padding:10px; border-radius:6px; text-align:center; font-weight:bold;}
.slot-container{ display:flex; justify-content:center; gap:10px; margin:20px; }
.reel{
  background:#fff; width:80px; height:80px; display:flex; align-items:center; justify-content:center; font-size:30px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.3);
}
.controls{ display:flex; justify-content:center; gap:10px; margin-top:10px; }
input[type="number"]{ width:80px; padding:6px; border-radius:6px; border:1px solid #ccc; }
button{ padding:6px 14px; border:none; border-radius:6px; background:#d81b60; color:#fff; cursor:pointer; font-weight:bold; }
button:disabled{ background:#aaa; cursor:not-allowed; }
.result{ text-align:center; font-weight:bold; margin-top:20px; font-size:18px; }
</style>
</head>
<body>

<div class="header">
  <div class="left" onclick="location.href='dashboard.html'">‚¨ÖÔ∏è Dashboard</div>
  <div class="balance" id="balanceBtn">Tap To Balance</div>
  <div class="logout" id="logoutBtn">‚éã</div>
</div>

<div class="notice">üé∞ Lucky Bet Slot Game</div>

<div class="slot-container">
  <div class="reel" id="reel1">‚ùì</div>
  <div class="reel" id="reel2">‚ùì</div>
  <div class="reel" id="reel3">‚ùì</div>
</div>

<div class="controls">
  <input type="number" id="betAmount" placeholder="‡ß≥ Bet" min="10" value="10">
  <button id="spinBtn">Spin üé∞</button>
</div>

<div class="result" id="result"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const balanceBtn = document.getElementById("balanceBtn");
let showBalance = false;
let liveBalance = 0;
let currentUser;

/* AUTH CHECK */
onAuthStateChanged(auth, async (user)=>{
  if(!user) location.href="index.html";
  currentUser = user;
  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()){
    await updateDoc(userRef, {
      uid: user.uid,
      phone: user.phoneNumber || "",
      role: "user",
      balance: 0,
      createdAt: serverTimestamp()
    });
  }
  onSnapshot(userRef, docSnap=>{
    if(docSnap.exists()){
      liveBalance = docSnap.data().balance || 0;
      if(showBalance) balanceBtn.innerText = "‡ß≥ "+liveBalance;
    }
  });
});

/* Toggle balance */
balanceBtn.onclick = ()=>{
  showBalance = !showBalance;
  balanceBtn.innerText = showBalance ? "‡ß≥ "+liveBalance : "Tap To Balance";
};

/* Logout */
document.getElementById("logoutBtn").onclick = async ()=>{
  await signOut(auth);
  location.href="index.html";
};

/* SLOT GAME LOGIC */
const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
const betInput = document.getElementById('betAmount');
const spinBtn = document.getElementById('spinBtn');
const resultText = document.getElementById('result');

const symbols = ["üçí","üçã","üîî","‚≠ê","üíé","7Ô∏è‚É£"];

spinBtn.addEventListener('click', async ()=>{
  const bet = parseInt(betInput.value);
  if(isNaN(bet) || bet <= 0){
    alert("‡¶¨‡ßá‡¶ü ‡¶ï‡¶§ ‡¶†‡¶ø‡¶ï ‡¶®‡ßá‡¶á!");
    return;
  }
  if(bet > liveBalance){
    alert("‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏ ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶®‡¶Ø‡¶º!");
    return;
  }

  spinBtn.disabled = true;
  resultText.innerText = "Spinning...";

  // Spin animation
  const finalSymbols = [];
  reels.forEach((reel, idx)=>{
    const sym = symbols[Math.floor(Math.random()*symbols.length)];
    finalSymbols.push(sym);
    reel.innerText = "üé∞";
  });

  setTimeout(async ()=>{
    reels.forEach((reel, idx)=>{ reel.innerText = finalSymbols[idx]; });

    // Check win
    const win = finalSymbols[0]===finalSymbols[1] && finalSymbols[1]===finalSymbols[2];
    let newBalance = liveBalance;
    if(win){
      const winAmount = bet * 5;
      newBalance += winAmount;
      resultText.innerText = `üéâ You Win! +‡ß≥${winAmount}`;
    } else {
      newBalance -= bet;
      resultText.innerText = `üíî You Lose! -‡ß≥${bet}`;
    }

    // Update balance in Firestore
    const userRef = doc(db,"users",currentUser.uid);
    await updateDoc(userRef, { balance:newBalance });

    spinBtn.disabled = false;
  }, 1000);
});
</script>

</body>
</html>
