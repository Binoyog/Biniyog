<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lucky Bet | Live Slot Game</title>
<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background: linear-gradient(135deg,#ffe4e1,#fff0f5);
  display:flex;
  flex-direction:column;
  min-height:100vh;
  align-items:center;
}
/* Header */
.header{
  background:#d81b60;
  color:#fff;
  padding:16px;
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header .left{ cursor:pointer; font-weight:bold; }
.header .balance{
  background:#fff;
  color:#d81b60;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
  margin-right:12px;
}
.logout{ font-size:20px; cursor:pointer; }

/* Notice */
.notice{
  background:#f9a825;
  text-align:center;
  padding:12px;
  font-weight:bold;
  font-size:16px;
  color:#000;
  width:90%;
  max-width:400px;
  border-radius:10px;
  margin:12px 0;
}

/* Slot Machine Card */
.slot-container{
  background:#fff;
  width:350px;
  max-width:90%;
  padding:30px 20px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 6px 20px rgba(0,0,0,0.25);
}
.reels{
  display:flex;
  justify-content:space-between;
  margin:20px 0;
}
.reel{
  font-size:50px;
  width:80px;
  height:80px;
  background:#ffe4e1;
  display:flex;
  justify-content:center;
  align-items:center;
  border-radius:12px;
  box-shadow:inset 0 0 5px #d81b60;
  transition: transform 0.3s;
}
.spin-btn{
  background:#d81b60;
  color:#fff;
  font-size:20px;
  padding:12px 28px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  transition:0.3s;
}
.spin-btn:hover{ background:#b71c1c; }
.result{ margin-top:20px; font-size:18px; font-weight:bold; min-height:30px; }
input[type=number]{
  width:100px;
  padding:6px;
  font-size:16px;
  margin:10px 0;
  border-radius:6px;
  border:1px solid #ccc;
  text-align:center;
}

/* Win History */
.history{
  margin-top:20px;
  width:90%;
  max-width:400px;
  background:#fff;
  padding:12px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
}
.history table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
.history th, .history td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
</style>
</head>
<body>

<div class="header">
  <div class="left" onclick="location.href='lucky-bet.html'">‚Üê Back</div>
  <div style="display:flex; align-items:center;">
    <div class="balance" id="balanceBtn">Tap To Balance</div>
    <div class="logout" id="logoutBtn">‚éã</div>
  </div>
</div>

<div class="notice">Live Casino Slot Game</div>

<div class="slot-container">
  <label>Bet Amount: ‡ß≥ <input type="number" id="betAmount" min="50" value="50"></label>
  <div class="reels">
    <div class="reel" id="reel1">üçí</div>
    <div class="reel" id="reel2">üçã</div>
    <div class="reel" id="reel3">üîî</div>
  </div>
  <button class="spin-btn" onclick="spin()">üé∞ Spin!</button>
  <div class="result" id="resultText"></div>
</div>

<div class="history">
  <h4>Win History</h4>
  <table id="historyTable">
    <tr><th>#</th><th>Bet</th><th>Result</th><th>Balance</th></tr>
  </table>
</div>

<footer style="margin-top:auto;padding:12px;font-size:14px;color:#555;">Live Slot Game ‚Ä¢ Lucky Bet</footer>

<script type="module">
// Firebase setup
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, getDoc, setDoc, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const balanceBtn = document.getElementById('balanceBtn');
const resultText = document.getElementById('resultText');
const betInput = document.getElementById('betAmount');
const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
const historyTable = document.getElementById('historyTable');

let showBalance = false;
let liveBalance = 0;
let historyCount = 0;

// Auth + Realtime Balance
onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  const userRef = doc(db,"users",user.uid);
  const snap = await getDoc(userRef);

  if(!snap.exists()){
    await setDoc(userRef,{
      uid:user.uid,
      phone:user.phoneNumber||"",
      role:"user",
      balance:1000,
      history:[],
      createdAt:serverTimestamp()
    });
  }

  onSnapshot(userRef,(docSnap)=>{
    if(docSnap.exists()){
      liveBalance = docSnap.data().balance || 0;
      if(showBalance) balanceBtn.innerText = "‡ß≥ "+liveBalance;
    }
  });
});

// Toggle balance
balanceBtn.onclick = ()=>{ showBalance = !showBalance; balanceBtn.innerText = showBalance?"‡ß≥ "+liveBalance:"Tap To Balance"; };

// Logout
document.getElementById('logoutBtn').onclick = async()=>{ await signOut(auth); location.href="index.html"; };

// Slot Logic
const symbols = ['üçí','üçã','üîî','‚≠ê','üçâ','üíé'];

function spin(){
  const bet = parseInt(betInput.value);
  if(bet>liveBalance){ alert("Insufficient balance!"); return; }

  resultText.innerText = "";
  let finalSymbols = [];

  reels.forEach((reel,idx)=>{
    const symbol = symbols[Math.floor(Math.random()*symbols.length)];
    reel.style.transform='rotateX(360deg)';
    setTimeout(()=>{ reel.style.transform='rotateX(0deg)'; reel.innerText=symbol; },300);
    finalSymbols.push(symbol);
  });

  setTimeout(async()=>{
    let resultTextMsg="";
    let winAmount=0;
    if(finalSymbols[0]===finalSymbols[1] && finalSymbols[1]===finalSymbols[2]){
      resultTextMsg="üéâ Jackpot!";
      winAmount = bet*10;
    } else if(finalSymbols[0]===finalSymbols[1] || finalSymbols[1]===finalSymbols[2] || finalSymbols[0]===finalSymbols[2]){
      resultTextMsg="üòä Small Win!";
      winAmount = bet*2;
    } else{
      resultTextMsg="üò¢ Try Again!";
      winAmount = -bet;
    }

    resultText.innerText = resultTextMsg;
    liveBalance += winAmount;
    if(showBalance) balanceBtn.innerText = "‡ß≥ "+liveBalance;

    // Update Firestore balance + history
    const userRef = doc(db,"users",auth.currentUser.uid);
    await updateDoc(userRef,{
      balance: liveBalance,
      history: arrayUnion({
        timestamp: serverTimestamp(),
        bet: bet,
        result: resultTextMsg,
        balance: liveBalance
      })
    });

    // Add to history table
    historyCount++;
    const row = historyTable.insertRow(-1);
    row.insertCell(0).innerText = historyCount;
    row.insertCell(1).innerText = bet;
    row.insertCell(2).innerText = resultTextMsg;
    row.insertCell(3).innerText = liveBalance;

  },350);
}
</script>

</body>
</html>
