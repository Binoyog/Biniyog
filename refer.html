<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | Referral Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg,#0b1a33,#1a2a4d);
  color:#fff;
  font-size:14px;
}
.container{
  max-width:1000px;
  margin:auto;
  padding:20px;
}
.header-card{
  background: linear-gradient(90deg,#18f2c2,#1a9cff);
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
  margin-bottom:20px;
}
.header-card h2{
  margin:0;
  font-size:20px;
  color:#000;
}
.ref-link{
  display:inline-block;
  background:#ffc107;
  color:#000;
  padding:6px 10px;
  margin:10px 0;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.ref-info{
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}
.ref-info p{
  margin:4px 0;
}
.level{
  font-weight:bold;
  padding:2px 6px;
  border-radius:4px;
}
.vip{background:#ffeb3b;color:#000;}
.platinum{background:#ff44aa;color:#fff;}
.bonus{color:#00ff00;font-weight:bold;}
.refer-list{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
}
.refer-card{
  background: linear-gradient(135deg,#1a2a4d,#2a3a5d);
  padding:10px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.6);
  transition:transform 0.2s,box-shadow 0.2s;
  font-size:13px;
}
.refer-card:hover{
  transform:translateY(-4px);
  box-shadow:0 6px 20px rgba(0,0,0,0.7);
}
.refer-card b{
  display:block;
}
.refer-card .bonus{
  display:inline-block;
  margin-top:4px;
}
button.copy-btn{
  background:#18f2c2;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  color:#000;
  margin-left:6px;
}
@media(max-width:768px){
  .ref-info{flex-direction:column;}
  .refer-list{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="container">
  <div class="header-card">
    <h2>Referral Dashboard</h2>
    <div>
      <span>আপনার রেফার লিঙ্ক: </span>
      <span class="ref-link" id="refLink">Loading...</span>
      <button class="copy-btn" onclick="copyLink()">Copy</button>
    </div>
    <div class="ref-info">
      <p>মোট রেফার: <span id="totalRefers">0</span></p>
      <p>আপনার লেভেল: <span id="refLevel" class="level">Normal</span></p>
      <p>বোনাস: <span id="refBonus" class="bonus">৳0</span></p>
      <p>আপনার কোড: <span id="myRefCode" class="bonus">Loading...</span></p>
    </div>
  </div>

  <div class="refer-list" id="referList">
    Loading...
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="login.html"; return; }
  currentUser=user;
  await loadReferralDashboard();
});

async function loadReferralDashboard(){
  const userSnap = await getDoc(doc(db,"users",currentUser.uid));
  if(!userSnap.exists()) return;
  const uData = userSnap.data();
  const refCode = uData.refCode || currentUser.uid;
  document.getElementById("refLink").innerText = `https://biniyog.com/register?ref=${refCode}`;
  document.getElementById("myRefCode").innerText = refCode;

  const q = query(collection(db,"users"),where("referredBy","==",refCode));
  const snap = await getDocs(q);

  let totalBonus=0;
  const referListDiv = document.getElementById("referList");
  referListDiv.innerHTML = "";
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    let bonus=0;
    if(d.hasDeposited) bonus=110;
    totalBonus+=bonus;

    referListDiv.innerHTML += `
      <div class="refer-card">
        <b>${d.name || "N/A"}</b> - ${d.phone || "-"}
        ${d.hasDeposited ? `<span class="bonus">+৳110</span>` : ""}
      </div>
    `;
  });

  document.getElementById("totalRefers").innerText = snap.size;
  document.getElementById("refBonus").innerText = `৳${totalBonus}`;

  const levelEl = document.getElementById("refLevel");
  if(snap.size>=250){ levelEl.innerText="Platinum"; levelEl.className="level platinum"; }
  else if(snap.size>=100){ levelEl.innerText="VIP"; levelEl.className="level vip"; }
  else{ levelEl.innerText="Normal"; levelEl.className="level"; }
}

function copyLink(){
  const text = document.getElementById("refLink").innerText;
  navigator.clipboard.writeText(text);
  alert("Copied!");
}
</script>
</body>
</html>
