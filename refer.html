<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | Refer & Earn</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:'Hind Siliguri',sans-serif;}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);display:flex;justify-content:center;align-items:center;color:#fff;}
.container{width:100%;max-width:420px;background:rgba(0,0,0,0.35);backdrop-filter:blur(10px);border-radius:18px;padding:22px;box-shadow:0 20px 40px rgba(0,0,0,0.45);text-align:center;}
h2{margin:0 0 12px;color:#2fffdc;}
.sub{font-size:14px;color:#c9fef2;margin-bottom:18px;}
.ref-box{background:rgba(255,255,255,0.1);border-radius:14px;padding:14px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.ref-code{font-size:18px;font-weight:600;letter-spacing:1px;}
.copy-btn{background:#18f2c2;border:none;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer;}
.copy-btn:hover{background:#12d9ae;}
.input-box{margin:10px 0;display:flex;gap:8px;}
.input-box input{flex:1;padding:8px;border-radius:14px;border:none;font-size:14px;}
.input-box button{padding:8px 12px;border:none;border-radius:14px;background:#18f2c2;color:#000;font-weight:600;cursor:pointer;}
.input-box button:hover{background:#12d9ae;}
.rules{background:rgba(0,0,0,0.25);border-radius:14px;padding:14px;margin-bottom:18px;text-align:left;color:#20B2AA;}
.rules p{margin:6px 0;font-size:14px;}
.level{font-weight:bold;margin-top:10px;display:inline-block;padding:4px 8px;border-radius:6px;color:#FF8COO;}
.back a{color:#20B2AA;text-decoration:none;font-size:14px;}
.back a:hover{text-decoration:underline;}
.msg{margin-top:8px;font-size:13px;color:#20B2AA;}
.refer-stats{text-align:left;margin-bottom:16px;}
.refer-stats p{margin:6px 0;color:#20B2AA;}
</style>
</head>
<body>
<div class="container">
  <h2>Refer & Earn</h2>
  <div class="sub">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°</div>
  <div class="ref-box">
    <div class="ref-code" id="refCode">----</div>
    <button class="copy-btn" id="copyBtn">Copy</button>
  </div>

  <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ -->
  <div class="input-box">
    <input type="tel" id="newUserPhone" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" maxlength="11" pattern="[0-9]{11}" required>
    <button id="submitReferral">Submit</button>
  </div>

  <div class="msg" id="msg"></div>

  <div class="refer-stats">
    <p>‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡ßá‡¶∞ ‡¶™‡¶∞‡ßá ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<span id="totalRefers">‡ß≥.</span></p>
    <p>‡¶≤‡ßá‡¶≠‡ßá‡¶≤: <span id="refLevel" class="level">Normal</span></p>
  </div>

  <div class="rules">
    <p>‚úÖ </p>
    <p>‚≠ê 100 ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ => VIP ‡¶≤‡ßá‡¶≠‡ßá‡¶≤</p>
    <p>üíé 250 ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ => Platinum ‡¶≤‡ßá‡¶≠‡ßá‡¶≤</p>
  </div>

  <div class="back">
    <a href="dashboard.html">‚Üê Back to dashboard</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;
let refCode;
let uData; // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="login.html"; return; }
  currentUser = user;

  // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
  const uRef = doc(db,"users",currentUser.uid);
  const uSnap = await getDoc(uRef);
  if(!uSnap.exists()) return;
  uData = uSnap.data();

  // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶°
  if(uData.refCode){ refCode = uData.refCode; } 
  else { 
    refCode = Math.random().toString(36).substring(2,8).toUpperCase(); 
    await updateDoc(uRef,{refCode}); 
    uData.refCode = refCode;
  }
  document.getElementById("refCode").innerText = refCode;

  // ‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞
  const q = query(collection(db,"referrals"), where("uid","==",currentUser.uid));
  const snap = await getDocs(q);
  document.getElementById("totalRefers").innerText = snap.size;

  // ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£
  const levelEl = document.getElementById("refLevel");
  if(snap.size>=250){ levelEl.innerText="Platinum"; }
  else if(snap.size>=100){ levelEl.innerText="VIP"; }
  else{ levelEl.innerText="Normal"; }
});

// ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ï‡¶™‡¶ø
document.getElementById("copyBtn").addEventListener("click",()=>{
  navigator.clipboard.writeText(refCode).then(()=>{
    const msgEl = document.getElementById("msg");
    msgEl.innerText = "‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‚úîÔ∏è";
    setTimeout(()=>{ msgEl.innerText = ""; },3000);
  });
});

// ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü
document.getElementById("submitReferral").addEventListener("click", async()=>{
  const phone = document.getElementById("newUserPhone").value.trim();
  if(!/^\d{11}$/.test(phone)){ alert("‡¶∏‡¶†‡¶ø‡¶ï ‡ßß‡ßß ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"); return; }
  try {
    await addDoc(collection(db,"referrals"),{
      uid: currentUser.uid,              // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ UID
      referrerPhone: uData.phone || "N/A", // ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶´‡ßã‡¶®
      newUserPhone: phone,               // ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶´‡ßã‡¶®
      timestamp: serverTimestamp(),
      bonusGiven: false,
      status: "pending"
    });
    const msgEl = document.getElementById("msg");
    msgEl.innerText = "‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úîÔ∏è";
    document.getElementById("newUserPhone").value = "";
    setTimeout(()=>{ msgEl.innerText = ""; },3000);
  } catch(err){
    console.error(err);
    alert("‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
  }
});
</script>
</body>
</html>
