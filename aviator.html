<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aviator | Lucky Bet</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
.header { display:flex; justify-content:space-between; align-items:center; background:#d81b60; color:#fff; padding:12px 16px; }
.header .title { font-weight:bold; font-size:16px; }
.header .balance { background:#fff; color:#d81b60; padding:4px 12px; border-radius:20px; font-size:14px; cursor:pointer; }
.main { padding:12px; }
.flight-area { position:relative; background:#e0f7fa; height:300px; border-radius:12px; overflow:hidden; margin-bottom:12px; }
.plane { position:absolute; width:50px; bottom:0; left:0; transition: transform 0.05s linear; }
.crash-img { position:absolute; width:100%; height:100%; top:0; left:0; display:none; background:url('https://i.ibb.co/ZK1pT1y/crash.png') center center no-repeat; background-size:contain; }
.crash-text { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:24px; font-weight:bold; color:red; display:none; text-shadow:2px 2px #000; }
.users { font-size:14px; color:#555; margin-bottom:12px; }
.graph { height:150px; background:#fff; border-radius:10px; padding:6px; margin-bottom:12px; position:relative; overflow:hidden; }
.graph canvas { width:100%; height:100%; }
.bet-display { margin-bottom:12px; font-size:14px; }
.controls { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
.controls input { padding:6px; width:100px; border-radius:6px; border:1px solid #ccc; }
.controls button { padding:6px 12px; background:#d81b60; color:#fff; border:none; border-radius:6px; cursor:pointer; }
.floating-bet { position:absolute; font-size:12px; font-weight:bold; color:green; pointer-events:none; opacity:0.8; animation:floatUp 3s linear forwards; }
@keyframes floatUp { 0%{transform:translateY(0);} 100%{transform:translateY(-150px);opacity:0;} }
</style>
</head>
<body>

<div class="header">
  <div class="title">ðŸŽ¯ Aviator</div>
  <div class="balance" id="balanceBtn">à§³ 0</div>
</div>

<div class="main">
  <div class="users" id="usersCount">Active Users: 1023</div>
  <div class="flight-area" id="flightArea">
    <img src="https://i.ibb.co/wd5RGSP/aviator.png" class="plane" id="plane" alt="Plane">
    <div class="crash-img" id="crashImg"></div>
    <div class="crash-text" id="crashText"></div>
  </div>
  <div class="graph">
    <canvas id="graphCanvas"></canvas>
  </div>
  <div class="bet-display" id="betsDisplay">Active Bets: None</div>
  <div class="controls">
    <input type="number" id="betAmount" placeholder="Enter Bet">
    <button id="placeBet">Place Bet</button>
    <button id="cashOut">Cash Out</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const balanceBtn = document.getElementById('balanceBtn');
const plane = document.getElementById('plane');
const usersCountEl = document.getElementById('usersCount');
const betAmountInput = document.getElementById('betAmount');
const betsDisplay = document.getElementById('betsDisplay');
const crashImg = document.getElementById('crashImg');
const crashText = document.getElementById('crashText');
const flightArea = document.getElementById('flightArea');
const canvas = document.getElementById('graphCanvas');
const ctx = canvas.getContext('2d');

let balance = 0;
let activeBets = [];
let multiplier = 1;
let flightX = 0;
let flightY = 0;
let crashPoint = 3 + Math.random()*5;
let interval;
let graphData = [];

/* Responsive canvas */
canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

// Firebase Auth + live balance sync
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href="index.html"; return; }
  const userRef = doc(db,"users",user.uid);
  onSnapshot(userRef, (docSnap)=>{
    if(docSnap.exists()){
      balance = docSnap.data().balance || 0;
      balanceBtn.innerText = `à§³ ${balance}`;
    }
  });
});

// Simulate active users
setInterval(()=>{
  const users = 1000 + Math.floor(Math.random()*50);
  usersCountEl.innerText = `Active Users: ${users}`;
}, 3000);

// Plane Bezier flight
function bezierFlight(x){ return -0.0007*(x-150)*(x-150)+150; }

// Start Flight
function startFlight(){
  flightX=0; multiplier=1; crashPoint=3+Math.random()*5; activeBets=[]; betsDisplay.innerText="Active Bets: None";
  crashImg.style.display="none"; crashText.style.display="none"; graphData=[]; ctx.clearRect(0,0,canvas.width,canvas.height);

  interval = setInterval(()=>{
    flightX+=2; multiplier+=0.015;
    flightY=bezierFlight(flightX);
    plane.style.transform=`translate(${flightX}px,${flightY}px) rotate(${multiplier*5}deg)`;

    graphData.push(multiplier);
    drawGraph();

    if(multiplier >= crashPoint){
      clearInterval(interval);
      crashImg.style.display="block";
      crashText.innerText=`ðŸ’¥ Crashed at x${crashPoint.toFixed(2)}x`;
      crashText.style.display="block";
      activeBets=[];
      updateBetsDisplay();
      setTimeout(()=>startFlight(),2000);
    }
  },50);
}

// Draw multiplier graph
function drawGraph(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(graphData.length===0) return;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height - graphData[0]*20);
  for(let i=1;i<graphData.length;i++){
    let x = i*(canvas.width/100);
    let y = canvas.height - graphData[i]*20;
    ctx.lineTo(x,y);
  }
  ctx.strokeStyle="#d81b60"; ctx.lineWidth=2; ctx.stroke();
}

// Place Bet
document.getElementById('placeBet').onclick=()=>{
  const amount=parseInt(betAmountInput.value);
  if(amount>0 && amount<=balance){
    activeBets.push({amount,multiplier});
    balance-=amount; balanceBtn.innerText=`à§³ ${balance}`;
    const userRef = doc(db,"users",auth.currentUser.uid);
    updateDoc(userRef,{balance});

    const floatBet=document.createElement('div');
    floatBet.className='floating-bet';
    floatBet.innerText=`à§³${amount}`;
    floatBet.style.left=Math.random()*80+'%';
    flightArea.appendChild(floatBet);
    setTimeout(()=>flightArea.removeChild(floatBet),3000);

    updateBetsDisplay();
  }else alert('Invalid Bet');
}

// Cash Out
document.getElementById('cashOut').onclick=()=>{
  if(activeBets.length>0){
    let totalWin=0;
    activeBets.forEach(b=>{ totalWin+=Math.floor(b.amount*multiplier); });
    balance+=totalWin; balanceBtn.innerText=`à§³ ${balance}`;
    const userRef = doc(db,"users",auth.currentUser.uid);
    updateDoc(userRef,{balance});
    activeBets=[];
    updateBetsDisplay();
  }else alert('No Active Bet');
}

function updateBetsDisplay(){
  if(activeBets.length===0) betsDisplay.innerText="Active Bets: None";
  else betsDisplay.innerText="Active Bets: "+activeBets.map(b=>`à§³${b.amount}`).join(", ");
}

// Start Flight
startFlight();
</script>
</body>
</html>
