<!-- Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <h3 id="modalUserName">User Name</h3>
    <p><b>Phone:</b> <span id="modalUserPhone"></span></p>
    <p><b>Balance:</b> à§³<span id="modalUserBalance"></span></p>
    <p><b>Current Plan:</b> <span id="modalUserPlan">None</span></p>
    <p><b>Plan Days Left:</b> <span id="modalPlanDays">0</span></p>
    <textarea id="notificationText" placeholder="Enter message to send"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="sendBtn">Send</button>
      <button id="closeBtn" class="close-btn">Close</button>
    </div>
  </div>
</div>

<script>
// Modal elements
const userModal = document.getElementById("userModal");
const closeBtn = document.getElementById("closeBtn");
const sendBtn = document.getElementById("sendBtn");

// Close modal
closeBtn.addEventListener("click", ()=>{
  userModal.style.display = "none";
});

// Send notification
sendBtn.addEventListener("click", async()=>{
  const msg = document.getElementById("notificationText").value.trim();
  if(!msg){
    alert("Enter a message");
    return;
  }
  if(!currentUserId){
    alert("User not selected");
    return;
  }
  await addDoc(collection(db,"notifications"),{
    uid: currentUserId,
    message: msg,
    createdAt: serverTimestamp()
  });
  alert("Notification sent!");
  userModal.style.display = "none";
});

// Open modal (update plan fetch)
function openModal(uid, userData){
  currentUserId = uid;
  document.getElementById("modalUserName").innerText = userData.name || "No Name";
  document.getElementById("modalUserPhone").innerText = userData.phone || "N/A";
  document.getElementById("modalUserBalance").innerText = userData.balance || 0;

  // Fetch current plan from Firestore if exists
  const userDocRef = doc(db,"users",uid);
  getDoc(userDocRef).then(docSnap=>{
    if(docSnap.exists()){
      const data = docSnap.data();
      const planName = data.planName || "None";
      let daysLeft = 0;
      if(data.planEnd){
        const end = data.planEnd.toDate ? data.planEnd.toDate() : new Date(data.planEnd);
        const now = new Date();
        daysLeft = Math.ceil((end - now)/(1000*60*60*24));
        if(daysLeft < 0) daysLeft = 0;
      }
      document.getElementById("modalUserPlan").innerText = planName;
      document.getElementById("modalPlanDays").innerText = daysLeft;
    }
  });

  document.getElementById("notificationText").value = "";
  userModal.style.display = "block";
}

// Close modal on click outside
window.addEventListener("click", (e)=>{
  if(e.target == userModal){
    userModal.style.display = "none";
  }
});
</script>
