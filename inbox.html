<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>User Inbox | Biniyog</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#e5ddd5;
  }
  .app{
    display:flex;
    height:100vh;
  }

  .sidebar{
    width:30%;
    max-width:380px;
    background:#f0f0f0;
    border-right:1px solid #ccc;
    display:flex;
    flex-direction:column;
  }
  .sidebar-header{
    background:#075e54;
    color:#fff;
    padding:15px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .sidebar-header h2{ margin:0; font-size:16px; }
  .user-list{
    flex:1;
    overflow-y:auto;
  }
  .user-item{
    padding:12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid #ddd;
    cursor:pointer;
    background:#fff;
  }
  .user-item:hover{ background:#f7f7f7; }
  .user-info{ display:flex; flex-direction:column; }
  .user-info b{ font-size:14px; }
  .user-info span{ font-size:12px; color:#555; }
  .badge{
    background:#25d366;
    color:#fff;
    padding:3px 8px;
    border-radius:12px;
    font-size:12px;
  }

  .chat-area{
    flex:1;
    display:flex;
    flex-direction:column;
    background:#e5ddd5;
  }
  .chat-header{
    background:#075e54;
    color:#fff;
    padding:15px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .chat-header img{
    width:40px;
    height:40px;
    border-radius:50%;
    background:#fff;
  }
  .chat-header b{ font-size:16px; }
  .messages{
    flex:1;
    padding:15px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .message{
    max-width:60%;
    padding:10px 12px;
    border-radius:10px;
    font-size:14px;
    line-height:1.3;
  }
  .msg-user{
    background:#dcf8c6;
    align-self:flex-end;
  }
  .msg-admin{
    background:#fff;
    align-self:flex-start;
  }
  .msg-time{
    font-size:11px;
    color:#666;
    margin-top:4px;
    text-align:right;
  }
  .msg-img{
    max-width:180px;
    border-radius:10px;
    margin-top:8px;
  }

  .chat-footer{
    padding:10px;
    background:#f0f0f0;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .chat-footer input[type="text"]{
    flex:1;
    padding:10px;
    border-radius:20px;
    border:1px solid #ddd;
    font-size:14px;
  }
  .chat-footer input[type="file"]{
    padding:6px;
  }
  .chat-footer button{
    background:#25d366;
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:20px;
    cursor:pointer;
    font-size:14px;
  }
</style>
</head>
<body>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>User Inbox</h2>
      <span id="logoutBtn" style="cursor:pointer;">Logout</span>
    </div>

    <div class="user-list" id="userList">
      Loading...
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="chat-header" id="chatHeader">
      <img src="https://i.imgur.com/0y0y0y0.png" alt="user">
      <b>Select chat</b>
    </div>

    <div class="messages" id="messages">
      <div style="text-align:center;color:#666;">No conversation selected</div>
    </div>

    <div class="chat-footer">
      <input type="text" id="msgInput" placeholder="Type a message..." />
      <input type="file" id="fileInput" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let chatId = null;
let selectedUid = null;

// AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if(!user) return location.href="user-login.html";
  currentUser = user.uid;
  loadChats();
});

// LOGOUT
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  location.href="user-login.html";
}

// LOAD CHATS FOR THIS USER
async function loadChats(){
  const list = document.getElementById("userList");
  list.innerHTML = "";

  const q = query(collection(db,"chats"), where("uid","==",currentUser), orderBy("updatedAt","desc"));
  onSnapshot(q, (snap)=>{
    list.innerHTML = "";
    snap.docs.forEach(docSnap=>{
      const d = docSnap.data();
      list.innerHTML += `
        <div class="user-item" onclick="openChat('${docSnap.id}')">
          <div class="user-info">
            <b>${d.name}</b>
            <span>${d.lastMessage}</span>
          </div>
          ${d.unreadByUser ? `<span class="badge">New</span>` : ""}
        </div>
      `;
    });
  });
}

// OPEN CHAT
window.openChat = async (id) => {
  chatId = id;
  const cSnap = await getDoc(doc(db,"chats",id));
  if(!cSnap.exists()) return;
  const cData = cSnap.data();

  selectedUid = cData.uid;

  document.getElementById("chatHeader").innerHTML = `
    <img src="https://i.imgur.com/0y0y0y0.png" alt="user">
    <b>Admin</b>
  `;

  // set unread false
  await updateDoc(doc(db,"chats",chatId),{
    unreadByUser:false
  });

  loadMessages();
}

// LOAD MESSAGES
function loadMessages(){
  const msgBox = document.getElementById("messages");
  msgBox.innerHTML = "";

  const q = query(collection(db,"messages"), where("uid","==",currentUser), orderBy("createdAt","asc"));
  onSnapshot(q, (snap)=>{
    msgBox.innerHTML = "";
    snap.docs.forEach(docSnap=>{
      const m = docSnap.data();
      const cls = m.from === "user" ? "msg-user" : "msg-admin";
      const time = new Date(m.createdAt.toDate()).toLocaleTimeString();

      let html = `
        <div class="message ${cls}">
          ${m.text}
          <div class="msg-time">${time}</div>
        </div>
      `;

      // if file exists show image
      if(m.fileUrl){
        html = `
          <div class="message ${cls}">
            ${m.text ? m.text : ""}
            <img class="msg-img" src="${m.fileUrl}" />
            <div class="msg-time">${time}</div>
          </div>
        `;
      }

      msgBox.innerHTML += html;
    });
    msgBox.scrollTop = msgBox.scrollHeight;
  });
}

// SEND MESSAGE
document.getElementById("sendBtn").onclick = async () => {
  const text = document.getElementById("msgInput").value.trim();
  const fileInput = document.getElementById("fileInput");

  if(!chatId) return alert("No chat selected");

  let fileUrl = "";
  let fileType = "";

  // file upload
  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const storageRef = ref(storage, `chatFiles/${currentUser}/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    fileUrl = await getDownloadURL(storageRef);
    fileType = file.type;
  }

  const now = serverTimestamp();

  await addDoc(collection(db,"messages"),{
    uid: currentUser,
    from: "user",
    text: text,
    fileUrl: fileUrl,
    fileType: fileType,
    seen: false,
    createdAt: now,
    updatedAt: now
  });

  await updateDoc(doc(db,"chats",chatId),{
    lastFrom: "user",
    lastMessage: text || "File",
    unreadByAdmin:true,
    unreadByUser:false,
    updatedAt: now
  });

  document.getElementById("msgInput").value = "";
  fileInput.value = "";
};
</script>
</body>
</html>
