<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Inbox | User</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:#e8eaf6;
    font-size:12px;
  }
  .header{
    background:#0b1a33;
    color:#fff;
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .header h2{
    margin:0;
    font-size:16px;
  }
  .chatbox{
    display:flex;
    height:calc(100vh - 120px);
  }
  .left{
    width:35%;
    background:#fff;
    border-right:1px solid #ccc;
    overflow-y:auto;
  }
  .right{
    width:65%;
    background:#f2f2f2;
    display:flex;
    flex-direction:column;
  }
  .chat-item{
    padding:10px;
    border-bottom:1px solid #eee;
    cursor:pointer;
  }
  .chat-item:hover{background:#f7f7f7;}
  .chat-item .name{font-weight:bold;}
  .chat-item .last{color:#555; font-size:12px; margin-top:5px;}
  .chat-item .time{color:#999; font-size:11px; float:right;}
  .messages{
    flex:1;
    padding:10px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
  }
  .msg{
    max-width:70%;
    margin-bottom:10px;
    padding:8px 10px;
    border-radius:10px;
  }
  .msg.user{
    align-self:flex-end;
    background:#0b1a33;
    color:#fff;
  }
  .msg.admin{
    align-self:flex-start;
    background:#fff;
    color:#000;
  }
  .msg img{
    max-width:100%;
    border-radius:8px;
  }
  .sendbox{
    padding:10px;
    display:flex;
    gap:8px;
    background:#fff;
    border-top:1px solid #ccc;
  }
  .sendbox input[type="text"]{
    flex:1;
    padding:10px;
    border:1px solid #ccc;
    border-radius:5px;
  }
  .sendbox input[type="file"]{
    padding:10px;
  }
  .sendbox button{
    padding:10px 15px;
    background:#0b1a33;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
  }
</style>
</head>
<body>

<div class="header">
  <h2>Inbox</h2>
  <div id="userPhone">Loading...</div>
</div>

<div class="chatbox">
  <div class="left" id="chatList">
    Loading chats...
  </div>

  <div class="right">
    <div class="messages" id="messagesArea">
      Loading messages...
    </div>

    <div class="sendbox">
      <input type="text" id="msgInput" placeholder="Type a message...">
      <input type="file" id="fileInput">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, serverTimestamp, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
    authDomain: "biniyog-95d00.firebaseapp.com",
    projectId: "biniyog-95d00",
    storageBucket: "biniyog-95d00.firebasestorage.app",
    messagingSenderId: "523238228802",
    appId: "1:523238228802:web:a65183bdc4c268f94efedb"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatId = null;

  onAuthStateChanged(auth, async (user) => {
    if(!user) location.href="login.html";
    currentUser = user.uid;

    // show phone
    const userSnap = await getDocs(query(collection(db,"users"), where("__name__","==",user.uid)));
    userSnap.forEach(doc => {
      document.getElementById("userPhone").innerText = doc.data().phone || "User";
    });

    loadChats();
  });

  async function loadChats(){
    const chatList = document.getElementById("chatList");
    chatList.innerHTML="";

    const q = query(collection(db,"chats"), where("uid","==",currentUser), orderBy("updatedAt","desc"));
    const snap = await getDocs(q);

    if(snap.empty){
      chatList.innerHTML="No chats yet. Send a message.";
      return;
    }

    snap.forEach(docSnap => {
      const data = docSnap.data();
      const item = document.createElement("div");
      item.className="chat-item";
      item.innerHTML = `
        <div class="name">${data.name || "User"}</div>
        <div class="last">${data.lastMessage || "No message yet"}</div>
      `;
      item.onclick = () => openChat(docSnap.id);
      chatList.appendChild(item);
    });
  }

  async function openChat(chatId){
    currentChatId = chatId;
    loadMessages(chatId);
  }

  async function loadMessages(chatId){
    const messagesArea = document.getElementById("messagesArea");
    messagesArea.innerHTML="";

    const q = query(collection(db,"messages"), where("uid","==",currentUser), orderBy("createdAt","asc"));
    onSnapshot(q, (snap)=>{
      messagesArea.innerHTML="";
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const div = document.createElement("div");
        div.className = "msg " + (d.from=="user" ? "user" : "admin");

        let content = d.text || "";
        if(d.fileUrl){
          content += `<br><img src="${d.fileUrl}" />`;
        }

        div.innerHTML = content;
        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;
      });
    });
  }

  document.getElementById("sendBtn").onclick = async () => {
    const text = document.getElementById("msgInput").value.trim();
    const fileInput = document.getElementById("fileInput");

    // যদি chat না থাকে, auto create
    if(!currentChatId){
      const chatDoc = await addDoc(collection(db,"chats"),{
        uid: currentUser,
        name: "User",
        lastFrom: "user",
        lastMessage: "",
        unreadByAdmin: true,
        unreadByUser: false,
        updatedAt: serverTimestamp()
      });
      currentChatId = chatDoc.id;
      loadChats();
    }

    let fileUrl = "";
    let fileType = "";

    if(fileInput.files.length > 0){
      const file = fileInput.files[0];
      const storageRef = ref(storage, `chatFiles/${currentUser}/${Date.now()}_${file.name}`);
      await uploadBytes(storageRef, file);
      fileUrl = await getDownloadURL(storageRef);
      fileType = file.type;
    }

    const now = serverTimestamp();

    await addDoc(collection(db,"messages"),{
      uid: currentUser,
      from: "user",
      text: text,
      fileUrl: fileUrl,
      fileType: fileType,
      seen: false,
      createdAt: now,
      updatedAt: now
    });

    await updateDoc(doc(db,"chats",currentChatId),{
      lastFrom: "user",
      lastMessage: text || "File",
      unreadByAdmin:true,
      unreadByUser:false,
      updatedAt: now
    });

    document.getElementById("msgInput").value = "";
    fileInput.value = "";
  };

</script>
</body>
</html>
