<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Inbox</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; }
  .container { padding: 12px; }
  .chat-box { background: #fff; padding: 10px; border-radius: 8px; }
  .msg { margin: 6px 0; padding: 8px; border-radius: 8px; }
  .from-user { background: #d1e7dd; }
  .from-admin { background: #f8d7da; }
</style>
</head>
<body>

<div class="container">
  <h2>User Inbox</h2>

  <div class="chat-box">
    <div id="messages"></div>

    <textarea id="userMsg" placeholder="Type your message..." style="width:100%; height:80px;"></textarea>
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  onSnapshot,
  doc,
  setDoc,
  addDoc,
  serverTimestamp,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00",
  storageBucket: "biniyog-95d00.firebasestorage.app",
  messagingSenderId: "523238228802",
  appId: "1:523238228802:web:a65183bdc4c268f94efedb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  currentUser = user;
  loadMessages();
});

async function loadMessages() {
  // mark unreadByUser false
  await updateDoc(doc(db, "chats", currentUser.uid), { unreadByUser: false });

  const q = query(collection(db, "messages"), where("uid", "==", currentUser.uid), orderBy("createdAt", "asc"));
  onSnapshot(q, (snap) => {
    const msgDiv = document.getElementById("messages");
    msgDiv.innerHTML = "";
    snap.forEach(docSnap => {
      const m = docSnap.data();
      const p = document.createElement("div");
      p.className = "msg " + (m.from === "admin" ? "from-admin" : "from-user");
      p.innerText = m.text;
      msgDiv.appendChild(p);
    });
  });
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const text = document.getElementById("userMsg").value;
  if (!text) return;

  await addDoc(collection(db, "messages"), {
    uid: currentUser.uid,
    from: "user",
    text: text,
    seen: false,
    createdAt: serverTimestamp(),
    fileUrl: "",
    fileType: ""
  });

  await setDoc(doc(db, "chats", currentUser.uid), {
    uid: currentUser.uid,
    name: currentUser.displayName || "User",
    lastFrom: "user",
    lastMessage: text,
    unreadByUser: false,
    unreadByAdmin: true,
    updatedAt: serverTimestamp()
  }, { merge: true });

  document.getElementById("userMsg").value = "";
});
</script>
</body>
</html>
