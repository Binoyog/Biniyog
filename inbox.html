<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biniyog | Inbox</title>
<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#f2f2f2;
}

/* Header */
.header{
  background:#d81b60;
  color:#fff;
  padding:14px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.header h2{
  margin:0;
  font-size:18px;
}
.back-btn{
  cursor:pointer;
  font-size:18px;
}

/* Inbox list */
.inbox{
  margin:12px;
  background:#fff;
  padding:12px;
  border-radius:10px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.inbox p{
  font-size:14px;
  color:green;
  margin:6px 0;
  padding:8px;
  border-bottom:1px solid #e0e0e0;
  border-radius:4px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.inbox p.unread{
  font-weight:bold;
  background:#e6f4ea;
}

/* Timestamp */
.timestamp{
  font-size:10px;
  color:gray;
  margin-left:10px;
  white-space: nowrap;
}

/* Scrollable */
.scrollable{
  max-height:400px;
  overflow-y:auto;
}
</style>
</head>
<body>

<div class="header">
  <div class="back-btn" id="backBtn">⬅️ Back</div>
  <h2>Inbox</h2>
</div>

<div class="inbox scrollable" id="inboxList">
  <p>Loading messages...</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, doc, collection, onSnapshot, updateDoc, query, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBFsTzlRPoWHVXEHbKrPdwxslxZGa7Kqfw",
  authDomain: "biniyog-95d00.firebaseapp.com",
  projectId: "biniyog-95d00"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const inboxList = document.getElementById("inboxList");
const backBtn = document.getElementById("backBtn");

let currentUser = null;

/* Format timestamp to readable string */
function formatTimestamp(ts){
  if(!ts) return "";
  const date = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
  return date.toLocaleString('bn-BD', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});
}

/* Auth check */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.replace("index.html");
    return;
  }
  currentUser = user;

  const inboxRef = collection(db,"inbox");
  const inboxQuery = query(inboxRef, orderBy("createdAt","desc"));

  onSnapshot(inboxQuery, async (snapshot)=>{
    inboxList.innerHTML = "";
    if(snapshot.empty){
      inboxList.innerHTML = "<p>No messages yet.</p>";
      return;
    }

    let unreadCount = 0;
    const messages = [];

    for(const docSnap of snapshot.docs){
      const data = docSnap.data();
      if(data.uid === currentUser.uid){
        messages.push({id: docSnap.id, ...data});
      }
    }

    // নতুন মেসেজ সবসময় উপরে
    messages.sort((a,b)=>{
      return b.createdAt?.seconds - a.createdAt?.seconds;
    });

    for(const msg of messages){
      const p = document.createElement("p");
      const ts = formatTimestamp(msg.createdAt);
      p.innerHTML = `<span>${msg.message || ""}</span><span class="timestamp">${ts}</span>`;
      
      if(!msg.read){
        p.classList.add("unread");
        unreadCount++;
        // Mark as read immediately
        await updateDoc(doc(db,"inbox",msg.id), { read: true, readAt: serverTimestamp() });
      }

      inboxList.appendChild(p);
    }

    // Update unread badge in Dashboard
    const badge = window.parent?.document?.getElementById("inboxBadge");
    if(badge){
      badge.innerText = unreadCount > 0 ? unreadCount : "";
      badge.style.display = unreadCount>0 ? "inline" : "none";
    }
  });
});

/* Back to dashboard */
backBtn.addEventListener("click", ()=>{
  window.location.replace("dashboard.html");
});
</script>

</body>
</html>
