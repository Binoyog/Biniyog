<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Inbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;margin:0;background:#f5f5f5}
.header{background:#d81b60;color:#fff;padding:12px;text-align:center}
.chat{padding:10px;height:70vh;overflow-y:auto}
.msg{margin:6px 0;padding:8px 10px;border-radius:8px;max-width:70%}
.user{background:#d81b60;color:#fff;margin-left:auto}
.admin{background:#fff;color:#000}
.footer{display:flex;padding:10px;gap:6px;background:#fff}
input[type=text]{flex:1;padding:8px}
</style>
</head>
<body>

<div class="header">Inbox</div>

<div class="chat" id="chat"></div>

<div class="footer">
  <input type="file" id="file">
  <input type="text" id="msg" placeholder="Type message">
  <button id="send">Send</button>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getFirestore,doc,collection,addDoc,onSnapshot,orderBy,query,serverTimestamp,setDoc} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_DOMAIN",
  projectId:"YOUR_PROJECT_ID"
});

const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;

onAuthStateChanged(auth,user=>{
  if(!user) return location.href="index.html";
  uid = user.uid;

  const q = query(
    collection(db,"chats",uid,"messages"),
    orderBy("createdAt")
  );

  onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.from==="user"?"user":"admin");
      div.innerText=m.text||"ðŸ“Ž File sent";
      chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;
  });
});

send.onclick=async()=>{
  if(!msg.value) return;
  await addDoc(collection(db,"chats",uid,"messages"),{
    text:msg.value,
    from:"user",
    createdAt:serverTimestamp()
  });

  await setDoc(doc(db,"chats",uid),{
    lastMessage:msg.value,
    updatedAt:serverTimestamp()
  },{merge:true});

  msg.value="";
};
</script>

</body>
</html>
