<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Biniyog | My Investments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
.header{background:#0f766e;color:#fff;padding:15px;text-align:center}
.card{background:#fff;margin:15px;padding:15px;border-radius:10px}
.plan{border-bottom:1px solid #eee;padding:10px 0}
.plan:last-child{border:none}
.active{color:#16a34a;font-weight:bold}
.expired{color:#dc2626;font-weight:bold}
.back{text-align:center;margin:15px}
.back a{text-decoration:none;color:#0f766e}
</style>
</head>

<body>

<script>
const user = localStorage.getItem("loggedInUser");
if(!user){ location.href="index.html"; }
</script>

<div class="header">
<h2>üìà My Investments</h2>
</div>

<div class="card">
<h3>üí∞ Active / Completed Plans</h3>
<div id="plans"></div>
</div>

<div class="back">
<a href="dashboard.html">‚¨Ö Dashboard</a>
</div>

<script>
function getRefChain(u){
  let refs = JSON.parse(localStorage.getItem("refers")) || [];
  let chain = [];
  let current = u;

  while(true){
    let ref = refs.find(r => r.user === current);
    if(!ref) break;
    chain.push(ref.parent);
    current = ref.parent;
  }
  return chain; // [level1, level2, level3...]
}

function processIncome(){
  let investments = JSON.parse(localStorage.getItem("investments")) || [];
  let deposits = JSON.parse(localStorage.getItem("deposits")) || [];

  let now = Date.now();
  let updated = false;
  let html = "";

  investments.forEach(inv=>{
    if(inv.user !== user) return;

    let daysPassed = Math.floor((now - inv.start)/(1000*60*60*24));

    if(daysPassed > inv.days){
      inv.status = "expired";
      daysPassed = inv.days;
    }

    let totalEarn = daysPassed * inv.daily;
    let newIncome = totalEarn - inv.earned;

    if(newIncome > 0){
      // User daily income
      deposits.push({
        user: user,
        amount: newIncome,
        method: "Daily Income",
        time: Date.now()
      });

      // ---------- REFER INCOME ----------
      let chain = getRefChain(user);

      chain.forEach((refUser, index)=>{
        let percent = 0;
        if(index === 1) percent = 12;       // 2nd level
        else if(index === 2) percent = 5;   // 3rd level
        else if(index >= 3) percent = 2;    // Hand to hand

        if(percent > 0){
          let bonus = Math.floor(newIncome * percent / 100);
          if(bonus > 0){
            deposits.push({
              user: refUser,
              amount: bonus,
              method: `Refer Income (${percent}%)`,
              time: Date.now()
            });
          }
        }
      });

      inv.earned = totalEarn;
      updated = true;
    }

    html += `
      <div class="plan">
        <b>${inv.plan}</b><br>
        üíµ Daily: ‡ß≥${inv.daily}<br>
        üìÜ Days: ${inv.days}<br>
        üí∞ Earned: ‡ß≥${inv.earned}<br>
        Status:
        <span class="${inv.status==="active"?"active":"expired"}">
        ${inv.status}
        </span>
      </div>
    `;
  });

  if(updated){
    localStorage.setItem("investments", JSON.stringify(investments));
    localStorage.setItem("deposits", JSON.stringify(deposits));
  }

  document.getElementById("plans").innerHTML =
    html || "‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡ßá‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á";
}

processIncome();
</script>

</body>
</html>
